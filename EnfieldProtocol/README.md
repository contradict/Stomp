# Enfield S3 Serial Protocol Documentation

## Introduction

This documentation is incomplete and generated by watching the communication
between the Enfield configuration tool and a valve. The USB connection is
converte to serial on the bottom of the two boards inside the servo, I connected
after this conversion as shown here:
![Serial Connection](SerialConnection.jpg)

To monitor communication, RXD and TXD were each connected to the Receive wire of
another serial port on a second laptop and `twocolumn.py` was used to monitor
the data flow while interacting with the tool. Once the protocol was clear,
`enfield.py` was written to send and receive messages.

## The Protocol

Packets sent in both directions are fixed size and checksummed. All messages are
checksummed using the `modbus` CRC. Every valid packet produces a resppnse, the
valve never sends an unrequested packet. Baud rate is 115200.

### Commands

Commands are sent to the valve and have the format

    $CrVV#CC

`r` identifies the target of the command and `VV` is a 16-bit payload. `CC` is
the CRC.

### Responses

Responses from the valve have the format

    +VV#CC

The returned 16 bit data is `VV`and the checksum is `CC`

### Observed Reads

The following `r` values return data about the valve and do not seem to affect
its operation. When reading, `VV` in the command packet is always set to 0x1111.
See the manual for a description of ehat each parameter means.

Name             | `r` | Range   | Description
-----------------|-----|---------|-------------
ProportionalGain | 112 | 0-1000  | interpreted as 0-100.0%
DerivativeGain   | 113 | 0-1000  | 
ForceDamping     | 119 | 0-1000  | 
Offset           | 126 | 0-1000  | 
CommandInput     | 127 | 0-1     | 
FeedbackInput    | 128 | 0-1     | 
AreaRatio        | 129 | 0-32767 | 32767 * (rod end piston area / bore area)
CylinderBore     | 130 | 0-32767 | 1024 * Cylinder Bore in inches
MinimumPosition  | 131 | 0-1000  | 
MaximumPosition  | 132 | 0-1000  | 
PortConnection   | 133 | 0-1     | 
RampUp           | 134 | 0-1000  | 
RampDown         | 135 | 0-1000  | 
DeadBand         | 137 | 0-1000  | 
DitherAmplitude  | 138 | 0-1000  | 
ValveOffset      | 139 | 0-1000  | 
FeedbackPolarity | 144 | 0-1     | 
DigitalCommand   | 145 | 0-4095  | 
CommandSource    | 146 | 0-1     | 
AnalogCommand    | 152 | 0-4095  | 
FeedbackPosition | 153 | 0-4095  | 
BaseEndPressure  | 154 |         | 
RodEndPressure   | 155 |         | 
SpoolPosition    | 158 | 0-4096  | Idles at 2048

### Observed Writes

These operations change the state of the servo, but are not persisted acros
power cycles until `SaveConfiguration` is sent.

Name              | 'r' | Range   | Description
------------------|-----|---------|------------
ProportionalGain  | 1   | 0-1000  |
DerivativeGain    | 2   | 0-1000  |
ForceDamping      | 8   | 0-1000  |
AreaRatio         | 12  | 0-32767 | 32767 * (rod end piston area / bore area)
CylinderBore      | 13  | 0-32767 | 1024 * Cylinder Bore in inches
Offset            | 15  | 0-1000  |
CommandInput      | 16  | 0-1     | 0-4-20mA, 1-0-10v
FeedbackInput     | 17  | 0-1     | 0-4-20mA, 1-0-10v
MinimumPosition   | 20  | 0-1000  |
MaximumPosition   | 21  | 0-1000  |
PortConnection    | 22  | 0-1     | 0-standard, 1-transposed
RampUp            | 23  | 0-1000  |
RampDown          | 24  | 0-1000  |
DeadBand          | 26  | 0-1000  |
DitherAmplitude   | 27  | 0-1000  |
ValveOffset       | 28  | 0-1000  |
FeedbackPolarity  | 33  | 0-1     | 0-normal, 1-inverted
CommandSource     | 89  | 0-1     | 1-analog, 0-slider
DigitalCommand    | 88  | 0-4095  |
Unknown           | 149 | 0x2222  | written with value 0x2222 on startup by the Enfield tool
Unknown           | 177 | 0       | written to 0 on Enfield tool startup
Unknown           | 185 | 0       | written to 0 on Enfield tool startup
Unknown           | 224 | 0       | always written 0 after changing command input type
SaveConfiguration | 225 | 0       | write 0 to save configuration
